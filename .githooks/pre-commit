#!/usr/bin/env bash
# This script runs before each commit to ensure that all staged dart files are 
# formatted and that there are no issues found by flutter analyze.

set -euo pipefail

# Hook metadata
HOOK_VERSION="1.1.3"
HOOK_NAME="pre-commit"
MINIMUM_DART_VERSION="3.0.0"
MINIMUM_FLUTTER_VERSION="3.13.0"

# Colors for output
PRC='\033[33;1m' # Process - yellow
SCC='\033[32;1m' # Success - green
ERR='\033[31;1m' # Error - red
INF='\033[36;1m' # Info - cyan
NC='\033[0m'     # No color

PANA_OUTPUT_DIR=".pana_reports"
PANA_OUTPUT_FILE="${PANA_OUTPUT_DIR}/pana_report_$(date +%Y%m%d_%H%M%S).json"

# Function to print colored messages
log() {
    echo -e "${2:-$PRC}$1${NC}\n"
}

# Function to create reports directory
setup_reports_dir() {
    if [ ! -d "$PANA_OUTPUT_DIR" ]; then
        mkdir -p "$PANA_OUTPUT_DIR"
        log "üìÅ Created reports directory: $PANA_OUTPUT_DIR" "$INF"
    fi
}

# Check if dart is available
if ! command -v dart >/dev/null 2>&1; then
    log "Dart command not found. Please ensure Dart is installed and in your PATH." "$ERR"
    exit 1
fi

# Check if flutter is available
if ! command -v flutter >/dev/null 2>&1; then
    log "Flutter command not found. Please ensure Flutter is installed and in your PATH." "$ERR"
    exit 1
fi

log "üì¶ Running ${HOOK_NAME} hook v${HOOK_VERSION}"

# Get all staged dart files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM "*.dart" | tr '\n' ' ')

# Early exit if no Dart files are staged
if [ -z "$STAGED_FILES" ]; then
    log "No Dart files to check, proceeding with commit." "$SCC"
    exit 0
fi

if [ -n "$STAGED_FILES" ]; then
    log "üõ† Formatting staged files..."
    
    # Check if files exist (in case they were deleted)
    for file in $STAGED_FILES; do
        if [ ! -f "$file" ]; then
            continue
        fi
        
        # Format each file individually to better handle errors
        if ! fvm dart format . -l 120 "$file"; then
            log "Failed to format $file" "$ERR"
            exit 1
        fi
        git add "$file"
    done

    log "üîç Running flutter analyze..."
    if ! fvm flutter analyze; then
        log "‚ùå Flutter analyze found issues, please fix them before committing!" "$ERR"
        exit 1
    fi

    log "üìä Running pana analysis..."

    setup_reports_dir
    
    # Check if pana is available, if not activate it
    if ! command -v pana >/dev/null 2>&1; then
        log "Pana not found, activating..." "$PRC"
        if ! dart pub global activate pana; then
            log "Failed to activate pana" "$ERR"
            exit 1
        fi
    fi
    
    # Run pana with exit code threshold 0
    if ! pana --exit-code-threshold 0 --json > "$PANA_OUTPUT_FILE" 2>&1; then
        log "‚ö†Ô∏è  Pana found issues, saving results to $PANA_OUTPUT_FILE..." "$ERR"
        exit 1
    fi
    
fi

# Check if there are staged changes
if git diff --cached --quiet; then
    log "‚ùå No changes to commit." "$ERR"
    exit 1
fi

log "‚úÖ All checks passed. Proceeding with commit." "$SCC"
exit 0